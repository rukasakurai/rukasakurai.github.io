# Azure アプリ サービスに移行する際の移行チェックリスト
## このページの内容について
マイクロソフトのユスフ・ランワラさんが以下に投稿している内容をベースとしています
https://azure.microsoft.com/blog/migration-checklist-when-moving-to-azure-app-service/
2021年6月11日時点では日本語の翻訳がなく、またブラウザの機械翻訳ですと分かりにくい部分があったので、機械翻訳に少し手を加えました。情報が古いと気が付いた部分については、最新にしていて以下「変更点」章にメモしています。

## Why
既存のアプリケーションを Azure App Service に移行しようとする方向けのチェックリストを提供することを目的としています。

## 考慮事項
まず、アプリケーションを Azure App Service に移行する前に、さまざまな考慮事項を見てみましょう。

- ポートバインド:  Azure App ServicesはHttpトラフィック用にポート80とHTTPSトラフィック用にポート443をサポートしています。他のポートを使用している場合はご注意ください
- GAC (グローバルアセンブリキャッシュ) でのアセンブリの使用: これはサポートされていません。アセンブリをローカルビンに配置することをご検討ください
- IIS5互換モード: IIS互換モードはサポートされていません。Azure App Service では、各Web Appとその下にあるすべてのアプリケーションが、特定のアプリケーションプール設定のセットを使用して同じワーカープロセスで実行されます
- IIS7+スキーマコンプライアンス: Azure App Service IISスキーマで定義されていない要素が使用されている場合は、XDT変換の使用をご検討ください
- サイト毎に単一のアプリケーションプール: Azure App Serviceの各Web Appの下にあるすべてのアプリケーションは、同じアプリケーションプールで実行します。IISでアプリケーションプールが異なる場合は、共通の設定を使用して1つのアプリケーションプールを作成するか、アプリケーションごとに別のWebアプリを作成することを検討してください
- COMおよびCOM+コンポーネント: Azure App Serviceでは、プラットフォーム上のCOMコンポーネントの登録は許可されていません。サイトまたはアプリケーションがCOMコンポーネントを使用する場合は、これらのコンポーネントをマネージコードで書き直し、サイトまたはアプリケーションと共に配置する必要があります
- ISAPI拡張機能: Azure App ServiceはISAPI拡張機能の使用をサポートできますが、DLLはサイトと共にデプロイし、web.config 経由で登録する必要があります

上記の制限を考慮したら、アプリケーションを移行する必要があります。移行の最も簡単な方法は、Azure App Service Migration Assistantを使用することです。Azure App Service Migrationサイトとツールを使用して、WindowsおよびLinuxのWebサーバーからAzure App Serviceにサイトを移行できます。移行ツールの一部として、AzureでWeb Appとデータベースを作成し、コンテンツを発行してデータベースを発行します。

このツールは、WindowsサーバーとLinuxサーバーの両方で使用できます。Windows Serverの移行ツールは、ローカルコンピューターまたはリモートコンピューターから動作します。このオプションを使用すると、Windows Server 2003以降で実行されているIISからサイトを移行できます。

Linuxサイト移行ツールを使用すると、Apacheを実行しているLinux Webサーバーからクラウドにサイトを移行できます。現時点ではApacheのみがサポートされています。

詳細はLinuxサイト移行ツールを参照してください。

移行を決定したら、アプリケーションをAzure App Serviceに移行するために、次の領域を考慮する必要があります。

- オンプレミス統合: アプリケーションがAzureに移行されない他のアプリケーションと通信している場合は、アプリケーションがクラウドに移行したときに通信がどのように行われるかを考慮する必要があります。1つの解決策は、他のアプリケーションがRESTを使用してインターネット経由で通信できるようにすることです。この場合、サーバーをインターネットに公開するリスクはもちろんのこと、両方のアプリケーションの変更が必要になる場合があります。別のアプローチとしては、アプリケーションがホストされているAzure App Serviceからオンプレミスサーバーへの安全な接続を確立する方法があります。これは、要件に応じて次のいずれかの方法で行うことができます
  - Isolated App Service Planを使用してApp Service環境でアプリを展開します
  - Azure VNetとのVNET統合を有効にして、このAzure VNETとオンプレミスの間にサイト間VPNを確立し、App ServiceとオンプレミスVM間のルートを有効にします
  - ハイブリッド接続の確立
  - 等
- 認証: オンプレミスでは、ADとの相互信頼が存在するので、認証なしまたはWindows認証で問題なく済みます。Azureに移行する場合は、Azureアクティブディレクトリでの認証を有効にする必要があります。これは、Azure AD を介してユーザーを認証できるように構成の一部を変更することを意味します
- セッション状態: 理想的なケースでは、アプリケーションをステートレスにして、必要に応じてスケール/切り替えを行うことができます。それが不可能な場合は、セッション状態をAzure Redis Cacheに保存するように構成してください
- ファイルの永続性: 通常、Webサイトでは、保存する必要があるファイルをアップロードする必要があります。Azure App Serviceでは、App Serviceの外部にあるblob store等にファイルを保持することをお勧めします。Azure Storage SDK または REST API を使用してファイルを保存およびアクセスするようにアプリケーションを変更します
- アプリの設定/接続文字列: 環境に応じて変更されるアプリ設定と接続文字列がありますが、同じままの状態が発生します。環境に基づいて変更される環境については、ポータル/テンプレートで定義して、異なるデプロイスロットに対してオーバーライドできるようにします
- ロギング: ログ記録フレームワークがローカルに保存されたファイルにログを記録している場合は、Azure 診断または集中型BLOBストアにログを記録するように更新する必要があります。また、Azure App Insightsを含めるので、アプリケーションのパフォーマンスをより深く把握できます
- 証明書: 証明書は直接移行されません。Azureで作業できるようにするには、証明書を明示的にアップロードする必要があります。詳細については、SSL証明書のバインドに関するドキュメントを参照してください。Azure から直接証明書を購入することもできます。詳細は[ここ](https://docs.microsoft.com/azure/app-service/configure-ssl-certificate)
- カスタムドメイン: カスタムドメインは、CNAMEレコードの変更を介してAzure Web Appsに関連付けることができます。また、DNSを検証するためにApp Serviceを更新する必要があります。詳しくは、[ここ](https://docs.microsoft.com/azure/app-service/app-service-web-tutorial-custom-domain?tabs=cname)をご覧ください
- メール: 電子メールの送信には SMTPサーバーが必要です。App Serviceでは、同じ機能が提供されておらず、App Service内で構成する方法はありません。Azure IaaS VMで電子メールを送信するようにSMTP サーバーを設定できますが、制限を設けます。リレーサービスを使用して電子メールを送信することをお勧めします(Office 365 など)
- LDAPクエリ: ADなどのLDAPストアにクエリを実行する内部アプリケーションを構築している場合、Azure App Serviceでは機能しない場合があります。具体的には、アクティブディレクトリの場合は、ADを Azure ADに移動し、Graph API を使用してAzureに必要なクエリを実行できます。このためには、ディレクトリオブジェクトのクエリを許可するAzure ADにアプリケーションを登録する必要があります
- 共有/リンクされたデータベースクエリ: 複数のデータベースを持つアプリケーションに、追加の考えが必要です。クロスデータベースクエリがある場合は、エラスティックプールにデータベースを移動し、エラスティッククエリを使用してデータベース全体にクエリを実行する必要があります。データベースステートメント内にリンクされたデータベースがある場合、Azureではこのデータベースは許可されません。この場合、リンクされたデータベースクエリを回避するためにソリューションの再アーキテクチャが必要になる場合があります
- SQL Serverの機能: Azure SQLデータベースでサポートされていないサーバーレベルの機能が多数あります。SQL Managed Instanceを使わない場合、次の点を考慮する必要があります
  - SQLエージェント: スケジュールされた特定のアクティビティを実行する SQLエージェントを持つデータベースが多数表示されます。この機能の一部は、エラスティックジョブを使用して実装できます。残りの部分については、Web JobsやAzure Functionsをセットアップする必要があります
  - SSIS: 先に進んでVMにSSISを展開するか、Azure Data Factoryを使用してデータを読み込む/移行できます
  - SSRS: VMにSSRSを展開したり、アプリケーションでカスタマイズされたレポートを使用したり、Power BIを使用して直感的なレポートを生成したりできます
  - SSAS: SSASは、Azure Analysis Servicesと呼ばれる別のサービスとして使用できます
上記のすべてのソリューションでは、パブリックDNS経由でAzure SQLデータベースに接続する必要があることに注意してください。SQLファイアウォールを介して、必要なソースが明示的に許可されていることを確認できます。
- SQL ファイアウォール: これは見落とされがちですが、Azure SQLデータベースに接続して接続を有効にする明示的なIPを提供する必要があります。これには、Azure App Serviceと同様にSSMSを使用して管理するクライアントIPが含まれます

## 変更点
- リンク切れのものはリンク削除
- SQL Managed InstanceはGAしている
