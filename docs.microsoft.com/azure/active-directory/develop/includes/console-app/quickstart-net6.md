# Referenced
https://docs.microsoft.com/en-us/azure/active-directory/develop/console-app-quickstart?pivots=devlang-dotnet-core

# Overview
In this quickstart, you download and run a code sample that demonstrates how a .NET 6 console application can get an access token to call the Microsoft Graph API and display a [list of users](/graph/api/user-list) in the directory. The code sample also demonstrates how a job or a Windows service can run with an application identity, instead of a user's identity. The sample console application in this quickstart is also a daemon application, so it's a confidential client application.

The following diagram shows how the sample app works:

![Diagram that shows how the sample app generated by this quickstart works.](../../media/quickstart-v2-netcore-daemon/netcore-daemon-intro.svg)

## Prerequisites

This quickstart requires [.NET 6 SDK](https://dotnet.microsoft.com/download).


## Register and download the app
#### Step 1: Register your application
To register your application and add the app's registration information to your solution manually, follow these steps:

1. Sign in to the [Azure portal](https://portal.azure.com/).
1. If you have access to multiple tenants, use the **Directories + subscriptions** filter :::image type="icon" source="../../media/common/portal-directory-subscription-filter.png" border="false"::: in the top menu to switch to the tenant in which you want to register the application.
1. Search for and select **Azure Active Directory**.
1. Under **Manage**, select **App registrations** > **New registration**.
1. For **Name**, enter a name for your application. For example, enter **Daemon-console**. Users of your app will see this name, and you can change it later.
1. Select **Register** to create the application.
1. Under **Manage**, select **Certificates & secrets**.
1. Under **Client secrets**, select **New client secret**, enter a name, and then select **Add**. Record the secret value in a safe location for use in a later step.
1. Under **Manage**, select **API Permissions** > **Add a permission**. Select **Microsoft Graph**.
1. Select **Application permissions**.
1. Under the **User** node, select **User.Read.All**, and then select **Add permissions**.

#### Step 2: Download the sample code
`git clone https://github.com/Azure-Samples/active-directory-dotnetcore-daemon-v2`

#### Step 3: Configure your  project
1. In *appsettings.json*, replace the values of `Tenant`, `ClientId`, and `ClientSecret`:

   ```json
   "Tenant": "Enter_the_Tenant_Id_Here",
   "ClientId": "Enter_the_Application_Id_Here",
   "ClientSecret": "Enter_the_Client_Secret_Here"
   ```
   In that code:
   - `Enter_the_Application_Id_Here` is the application (client) ID for the application that you registered.
        To find the values for the application (client) ID and the directory (tenant) ID, go to the app's **Overview** page in the Azure portal.
   - Replace `Enter_the_Tenant_Id_Here` with the tenant ID or tenant name (for example, `contoso.microsoft.com`).
   - Replace `Enter_the_Client_Secret_Here` with the client secret that you created in step 1.
    To generate a new key, go to the **Certificates & secrets** page.

#### Step 4: Admin consent

If you try to run the application at this point, you'll receive an *HTTP 403 - Forbidden* error: "Insufficient privileges to complete the operation." This error happens because any app-only permission requires a global administrator of your directory to give consent to your application. Select one of the following options, depending on your role.

##### Global tenant administrator

If you're a global tenant administrator, go to **Enterprise applications** in the Azure portal. Select your app registration, and select **Permissions** from the **Security** section of the left pane. Then select the large button labeled **Grant admin consent for {Tenant Name}** (where **{Tenant Name}** is the name of your directory).


##### Standard user

If you're a standard user of your tenant, ask a global administrator to grant admin consent for your application. To do this, give the following URL to your administrator:

```url
https://login.microsoftonline.com/Enter_the_Tenant_Id_Here/adminconsent?client_id=Enter_the_Application_Id_Here
```

In that URL:
* Replace `Enter_the_Tenant_Id_Here` with the tenant ID or tenant name (for example, `contoso.microsoft.com`).
* `Enter_the_Application_Id_Here` is the application (client) ID for the application that you registered.

You might see the error "AADSTS50011: No reply address is registered for the application" after you grant consent to the app by using the preceding URL. This error happens because this application and the URL don't have a redirect URI. You can ignore it.

#### Step 5: Run the application
Run the application via command prompt, console, or terminal:

```dotnetcli
cd {ProjectFolder}\1-Call-MSGraph\daemon-console
dotnet run
```
You should see a list of users in Azure Active Directory as result.

This quickstart application uses a client secret to identify itself as a confidential client. The client secret is added as a plain-text file to your project files. For security reasons, we recommend that you use a certificate instead of a client secret before considering the application as a production application. For more information on how to use a certificate, see [these instructions](https://github.com/Azure-Samples/active-directory-dotnetcore-daemon-v2/#variation-daemon-application-using-client-credentials-with-certificates) in the GitHub repository for this sample.

## More information
This section gives an overview of the code required to sign in users. This overview can be useful to understand how the code works, what the main arguments are, and how to add sign-in to an existing .NET Core console application.

### MSAL.NET

Microsoft Authentication Library (MSAL, in the [Microsoft.Identity.Client](https://www.nuget.org/packages/Microsoft.Identity.Client) package) is the library that's used to sign in users and request tokens for accessing an API protected by the Microsoft identity platform. This quickstart requests tokens by using the application's own identity instead of delegated permissions. The authentication flow in this case is known as a [client credentials OAuth flow](../../v2-oauth2-client-creds-grant-flow.md). For more information on how to use MSAL.NET with a client credentials flow, see [this article](https://aka.ms/msal-net-client-credentials).

 You can install MSAL.NET by running the following command in the Visual Studio Package Manager Console:

```dotnetcli
dotnet add package Microsoft.Identity.Client
```

### MSAL initialization

You can add the reference for MSAL by adding the following code:

```csharp
using Microsoft.Identity.Client;
```

Then, initialize MSAL by using the following code:

```csharp
IConfidentialClientApplication app;
app = ConfidentialClientApplicationBuilder.Create(config.ClientId)
                                          .WithClientSecret(config.ClientSecret)
                                          .WithAuthority(new Uri(config.Authority))
                                          .Build();
```

 | Element | Description |
 |---------|---------|
 | `config.ClientSecret` | The client secret created for the application in the Azure portal. |
 | `config.ClientId` | The application (client) ID for the application registered in the Azure portal. You can find this value on the app's **Overview** page in the Azure portal. |
 | `config.Authority`    | (Optional) The security token service (STS) endpoint for the user to authenticate. It's usually `https://login.microsoftonline.com/{tenant}` for the public cloud, where `{tenant}` is the name of your tenant or your tenant ID.|

For more information, see the [reference documentation for `ConfidentialClientApplication`](/dotnet/api/microsoft.identity.client.iconfidentialclientapplication).

### Requesting tokens

To request a token by using the app's identity, use the `AcquireTokenForClient` method:

```csharp
result = await app.AcquireTokenForClient(scopes)
                  .ExecuteAsync();
```

|Element| Description |
|---------|---------|
| `scopes` | Contains the requested scopes. For confidential clients, this value should use a format similar to `{Application ID URI}/.default`. This format indicates that the requested scopes are the ones that are statically defined in the app object set in the Azure portal. For Microsoft Graph, `{Application ID URI}` points to `https://graph.microsoft.com`. For custom web APIs, `{Application ID URI}` is defined in the Azure portal, under **Application Registration (Preview)** > **Expose an API**. |

For more information, see the [reference documentation for `AcquireTokenForClient`](/dotnet/api/microsoft.identity.client.confidentialclientapplication.acquiretokenforclient).